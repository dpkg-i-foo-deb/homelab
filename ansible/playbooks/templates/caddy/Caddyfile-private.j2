# DO NOT MODIFY MANUALLY, GENERATED WITH ANSIBLE
# Global config
{
  # Enable OWASP Coraza
  order coraza_waf first

  admin 0.0.0.0:2019

  metrics

  servers {
    trusted_proxies static private_ranges
  }

}

# Snippets

# Logging
(logging) {
  log {
    output file /var/log/caddy/{args[0]} {
      roll_size 100mb
      roll_keep 5
      roll_keep_for 14d
      }
    format json
  }
}

# Proxy with compression. Uses plain HTTP
(proxy) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]}
}

# Proxy with compression. Uses https and ignores tls stuff
(proxy_tls) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

# Proxy with compression, uses oauth2-proxy as an OIDC intermediary
# first argument is your oauth2-proxy host. Second is your target
# backend host
(proxy_oauth) {
  encode {
    zstd better
    gzip 6
  }
  handle /oauth2/* {
    reverse_proxy {args[0]}
  }
  handle {
    forward_auth {args[0]} {
      uri /oauth2/auth
      copy_headers Authorization

      @bad status 401
      handle_response @bad {
        redir * /oauth2/start
      }
    }
    reverse_proxy {args[1]}
  }
}

# Proxy with compression, uses oauth2-proxy as an OIDC intermediary
# first argument is your oauth2-proxy host. Second is your target
# backend host
# Ignores TLS
(proxy_oauth_tls) {
  encode {
    zstd better
    gzip 6
  }
  handle /oauth2/* {
    reverse_proxy {args[0]}
  }
  forward_auth {args[0]} {
    uri /oauth2/auth
    copy_headers Authorization

    @bad status 401
    handle_response @bad {
      redir * /oauth2/start
    }
  }

  reverse_proxy {args[1]} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

# Fetch certificates using Cloudflare DNS

(letsencrypt_cloudflare_dns) {
  tls {
    dns cloudflare {env.CF_API_TOKEN}
    propagation_timeout -1
    propagation_delay 120s
  }
}

# OWASP Coraza Configuration
(owasp_coraza) {

  @waf_scan {
    # Static file filter
    not {
      method GET
      path *.jpg *.jpeg *.png *.gif *.ico *.svg *.webp *.tiff *.bmp *.heic # Pictures
      path *.mp3 *.wav *.flac *.aac *.ogg *.m4a *.wma *.opus *.mid *.midi # Audio
      path *.mp4 *.mkv *.avi *.mov *.wmv *.flv *.webm *.m4v *.mpg *.mpeg # Video
      path *.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx *.txt *.rtf *.epub # Documents
      path *.zip *.tar *.gz *.rar *.7z *.bz2 *.xz *.iso *.dmg # Archives
    }
    # Ultimate Websocket Filter
    not {
      method GET
      header Connection *Upgrade*
      header Upgrade websocket
      path /api/websocket /notifications/hub /guacamole/websocket-tunnel /api/live/ws /stable-* /socket.io/* /_static/src/browser/*
    }
  }

  coraza_waf @waf_scan {

    load_owasp_crs

    directives `
      Include @coraza.conf-recommended
      # block_search_ip=0 disables ip reputation checks (slow if not tuned)
      SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=2"
      # Threshold: 5 (Strict). Defaults are usually higher.
      SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
      SecRule REQUEST_HEADERS:Content-Type "@contains multipart/form-data" \
        "id:1005,phase:1,nolog,pass,ctl:requestBodyAccess=Off"

      # --- Load Rules ---
      Include @crs-setup.conf.example
      Include @owasp_crs/*.conf

      # --- Custom Overrides ---
      # Example: Whitelist a specific scanner IP
      # SecRule REMOTE_ADDR "@ipMatch 192.168.1.50" "id:1000,phase:1,allow,nolog,ctl:ruleEngine=Off"

      # Don't scan for Unix Command execution for username fields
      SecRule REQUEST_URI ".*" \
        "id:1010,phase:1,pass,nolog,\
        ctl:ruleRemoveTargetById=932260;ARGS:u,\
        ctl:ruleRemoveTargetById=932260;ARGS:username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.u"

      # Don't scan Grafana when it uses Prometheus sfuff
      SecRule REQUEST_HEADERS:Host "@streq {{ metrics_host }}.{{ internet_host }}" \
        "id:1012,phase:1,pass,nolog,chain"
        SecRule REQUEST_URI "@contains /api/ds/query" \
          "ctl:requestBodyAccess=Off"

      # Don't scan Grafana when saving dashboards
      SecRule REQUEST_HEADERS:Host "@streq metrics.baremetalcloud.org" \
        "id:1015,phase:1,pass,nolog,chain"                                                                                                           SecRule REQUEST_URI "@beginsWith /apis/dashboard.grafana.app" \
          "ctl:ruleRemoveByTag=OWASP_CRS"

      # Don't scan code-server when it uses Gemini Code Asssit
      SecRule REQUEST_HEADERS:Host "@rx ^({{ code_personal_host }}|{{ code_work_host }})" \
        "id:900100,\
        phase:1,\
        pass,\
        nolog,\
        ctl:ruleRemoveTargetById=930120;ARGS:vscode-resource-base-authority"

      # Don't scan Trilium admin API
      SecRule REQUEST_HEADERS:Host "@streq {{ notes_host }}.{{ internet_host }}" \
        "id:1014,phase:1,pass,nolog,chain"
          SecRule REQUEST_URI "@beginsWith /api/options" \
            "ctl:ruleEngine=Off"

      # Reject requests when Coraza doesn't like them
      SecRuleEngine On

      # Scan Response bodies
      SecResponseBodyAccess On

      # Only scan response bodies that are not binaries
      SecResponseBodyMimeType text/plain text/html text/xml application/json application/javascript

      # Cap the response buffer at 512KB
      SecResponseBodyLimit 524288

      # If a response body if too big, process it partially
      SecResponseBodyLimitAction ProcessPartial

      # Process request bodies in small 64KB chunks
      SecRequestBodyInMemoryLimit 65536

      # Reject uploads larger than 200MB
      SecRequestBodyLimit 209715200
      SecRequestBodyLimitAction Reject

      # Stop matching if a Regex takes too much work.
      SecPcreMatchLimit 1500
      SecPcreMatchLimitRecursion 1500

      # --- Audit Logging ---
      SecAuditLog /var/log/caddy/coraza_audit.log
      SecAuditLogFormat json
      SecAuditLogParts ABIJDEFHZ
      SecAuditEngine RelevantOnly
    `
  }
}

# Error Handling
(error_handler) {
  handle_errors {
    @blocked expression {err.status_code} == 403
    respond @blocked "Request blocked by OWASP Coraza WAF" 403
  }
}


{% for service in caddy_services %}
# {{ service.name }}
{{ caddy_lan_prefix }}.{{ service.host }}.{{ caddy_internet_host }},
{{ service.host }}.{{ caddy_internet_host }} {
  import logging {{ service.name }}.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
{% if service.oauth_proxy is defined %}
  {%- if service.tls %}
  import proxy_oauth_tls {{ service.oauth_proxy.ip }}:{{ service.oauth_proxy.port }} https://{{ service.ip }}:{{ service.port }}
  {% else %}
  import proxy_oauth {{ service.oauth_proxy.ip }}:{{ service.oauth_proxy.port }} {{ service.ip }}:{{ service.port }}
  {% endif %}
{% else %}
  {%- if service.tls %}
  import proxy_tls https://{{ service.ip }}:{{ service.port }}
  {% else %}
  import proxy {{ service.ip }}:{{ service.port }}
  {% endif %}
{% endif %}

}

{% endfor %}
