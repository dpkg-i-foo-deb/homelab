# DO NOT MODIFY MANUALLY, GENERATED WITH ANSIBLE
# Global config
{
  # Enable OWASP Coraza
  order coraza_waf first

  admin 0.0.0.0:2019

  metrics

  servers {
    trusted_proxies static private_ranges
  }

  log {
    output file /var/log/caddy/access.log
    format json
  }

}

# Snippets

# Proxy with compression. Uses plain HTTP
(proxy) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]} {
    header_up X-Real-IP {remote}
  }
}


# Proxy with compression. Uses https and ignores tls stuff
(proxy_tls) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]} {
    header_up X-Real-IP {remote}
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

# Fetch certificates using Cloudflare DNS

(letsencrypt_cloudflare_dns) {
  tls {
    dns cloudflare {env.CF_API_TOKEN}
    propagation_timeout -1
    propagation_delay 120s
  }
}

# OWASP Coraza Configuration
(owasp_coraza) {

  @static {
  path *.jpg *.jpeg *.png *.gif *.ico *.svg *.webp *.tiff *.bmp *.heic # Photos
  path *.mp3 *.wav *.flac *.aac *.ogg *.m4a *.wma *.opus *.mid *.midi # Music
  path *.mp4 *.mkv *.avi *.mov *.wmv *.flv *.webm *.m4v *.mpg *.mpeg # Video
  path *.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx *.txt *.rtf *.epub # Docs
  path *.zip *.tar *.gz *.rar *.7z *.bz2 *.xz *.iso *.dmg # Archives
  }

  coraza_waf {

    matcher not @static

    load_owasp_crs

    directives `
      Include @coraza.conf-recommended
      # block_search_ip=0 disables ip reputation checks (slow if not tuned)
      SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=2"
      # Threshold: 5 (Strict). Defaults are usually higher.
      SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
      SecRule REQUEST_HEADERS:Content-Type "@contains multipart/form-data" \
        "id:1005,phase:1,nolog,pass,ctl:requestBodyAccess=Off"

      # --- Load Rules ---
      Include @crs-setup.conf.example
      Include @owasp_crs/*.conf

      # --- Custom Overrides ---
      # Example: Whitelist a specific scanner IP
      # SecRule REMOTE_ADDR "@ipMatch 192.168.1.50" "id:1000,phase:1,allow,nolog,ctl:ruleEngine=Off"
      SecRuleEngine On
      # Disable response body checking due to low VPS RAM
      SecResponseBodyAccess Off
      # Process request bodies in small 64KB chunks
      SecRequestBodyInMemoryLimit 65536

      # Reject uploads larger than 200MB
      SecRequestBodyLimit 209715200
      SecRequestBodyLimitAction Reject

      # Stop matching if a Regex takes too much work.
      SecPcreMatchLimit 1500
      SecPcreMatchLimitRecursion 1500

      # --- Audit Logging ---
      SecAuditLog /var/log/caddy/coraza_audit.log
      SecAuditLogFormat json
      SecAuditLogParts ABIJDEFHZ
      SecAuditEngine RelevantOnly
    `
  }
}

# Error Handling
(error_handler) {
  handle_errors {
    @blocked expression {err.status_code} == 403
    respond @blocked "Request blocked by OWASP Coraza WAF" 403
  }
}

# Services Definition
# VPN Service

{{ vpn_host }}.{{ internet_host }} {
  import letsencrypt_cloudflare_dns
  import proxy 10.0.254.3:8080
}


# Authentication portal

{{ auth_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ auth_host }}.{{ internet_host }}
}

{{ remote_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ remote_host }}.{{ internet_host }}
}

{{ code_personal_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ code_personal_host }}.{{ internet_host }}
}

{{ code_work_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ code_work_host }}.{{ internet_host }}
}

# Music service

{{ music_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ music_host }}.{{ internet_host }}
}

# Note taking service

{{ notes_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ notes_host }}.{{ internet_host }}
}

{{ password_mgr_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ password_mgr_host }}.{{ internet_host }}
}

# RSS service

{{ rss_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ rss_host }}.{{ internet_host }}
}

# Photos service

{{ photos_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ photos_host }}.{{ internet_host }}
}

# Metrics service

{{ metrics_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ metrics_host }}.{{ internet_host }}
}

# Registry service

{{ registry_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ registry_host }}.{{ internet_host }}
}

# Home Assistant

{{ home_assistant_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ home_assistant_host }}.{{ internet_host }}
}

# AWX

{{ automation_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ automation_host }}.{{ internet_host }}
}

# Termix

{{ remote_ssh_host }}.{{ internet_host }} {
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ remote_ssh_host}}.{{ internet_host }}
}
