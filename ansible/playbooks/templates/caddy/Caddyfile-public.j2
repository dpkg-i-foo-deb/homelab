# DO NOT MODIFY MANUALLY, GENERATED WITH ANSIBLE
# Global config
{
  # Enable OWASP Coraza
  order coraza_waf first

  admin 0.0.0.0:2019

  metrics

  servers {
    trusted_proxies static private_ranges
  }

  log {
    output file /var/log/caddy/access.log
    format json
  }

}

# Snippets

# Proxy with compression. Uses plain HTTP
(proxy) {
  encode {
    zstd better
    gzip 6
  }
  header_up X-Real-IP {remote}
  reverse_proxy {args[0]}
}


# Proxy with compression. Uses https and ignores tls stuff
(proxy_tls) {
  encode {
    zstd better
    gzip 6
  }
  header_up X-Real-IP {remote}
  reverse_proxy {args[0]} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

# Fetch certificates using Cloudflare DNS

(letsencrypt_cloudflare_dns) {
  tls {
    dns cloudflare {env.CF_API_TOKEN}
    propagation_timeout -1
    propagation_delay 120s
  }
}

:80, :443 {
  coraza_waf {
    load_owasp_crs

    directives `
      Include @coraza.conf-recommended
      # block_search_ip=0 disables ip reputation checks (slow if not tuned)
      SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=2"
      # Threshold: 5 (Strict). Defaults are usually higher.
      SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"

      # --- Load Rules ---
      Include @crs-setup.conf.example
      Include @owasp_crs/*.conf

      # --- Custom Overrides ---
      # Example: Whitelist a specific scanner IP
      # SecRule REMOTE_ADDR "@ipMatch 192.168.1.50" "id:1000,phase:1,allow,nolog,ctl:ruleEngine=Off"

      # --- Audit Logging ---
      SecAuditLog /var/log/caddy/coraza_audit.log
      SecAuditLogFormat json
      SecAuditLogParts ABIJDEFHZ
      SecAuditEngine RelevantOnly
    `
  }

  # Services Definition
  # VPN Service

  {{ vpn_host }}.{{ internet_host }} {
    import proxy 10.0.254.3:8080
  }


  # Authentication portal

  {{ auth_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ auth_host }}.{{ internet_host }}
  }

  {{ remote_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ remote_host }}.{{ internet_host }}
  }

  {{ code_personal_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ code_personal_host }}.{{ internet_host }}
  }

  {{ code_work_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ code_work_host }}.{{ internet_host }}
  }

  # Music service

  {{ music_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ music_host }}.{{ internet_host }}
  }

  # Note taking service

  {{ notes_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ notes_host }}.{{ internet_host }}
  }

  {{ password_mgr_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ password_mgr_host }}.{{ internet_host }}
  }

  # RSS service

  {{ rss_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ rss_host }}.{{ internet_host }}
  }

  # Photos service

  {{ photos_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ photos_host }}.{{ internet_host }}
  }

  # Metrics service

  {{ metrics_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ metrics_host }}.{{ internet_host }}
  }

  # Registry service

  {{ registry_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ registry_host }}.{{ internet_host }}
  }

  # Home Assistant

  {{ home_assistant_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ home_assistant_host }}.{{ internet_host }}
  }

  # AWX

  {{ automation_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ automation_host }}.{{ internet_host }}
  }

  # Termix

  {{ remote_ssh_host }}.{{ internet_host }} {
    import letsencrypt_cloudflare_dns
    import proxy https://{{ lan_prefix }}.{{ remote_ssh_host}}.{{ internet_host }}
  }

  #ERROR HANDLING
  handle_errors {
      @blocked expression {http.error.status_code} == 403
      respond @blocked "Request blocked by OWASP Coraza WAF. Support ID: {http.request.header.x-request-id}" 403
  }
}