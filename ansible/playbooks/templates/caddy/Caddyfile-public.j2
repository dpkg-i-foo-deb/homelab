# DO NOT MODIFY MANUALLY, GENERATED WITH ANSIBLE
# Global config
{
  # Enable OWASP Coraza
  order coraza_waf first

  admin 0.0.0.0:2019

  metrics

  servers {
    trusted_proxies static private_ranges
  }
}

# Snippets

# Logging
(logging) {
  log {
    output file /var/log/caddy/{args[0]} {
      roll_size 100mb
      roll_keep 5
      roll_keep_for 14d
      }
    format json
  }
}

# Proxy with compression. Uses plain HTTP
(proxy) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]} {
    header_up X-Real-IP {remote}
  }
}


# Proxy with compression. Uses https and ignores tls stuff
(proxy_tls) {
  encode {
    zstd better
    gzip 6
  }
  reverse_proxy {args[0]} {
    header_up X-Real-IP {remote}
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

# Fetch certificates using Cloudflare DNS

(letsencrypt_cloudflare_dns) {
  tls {
    dns cloudflare {env.CF_API_TOKEN}
    propagation_timeout -1
    propagation_delay 120s
  }
}

# OWASP Coraza Configuration
(owasp_coraza) {

  @waf_scan {
    not path *.jpg *.jpeg *.png *.gif *.ico *.svg *.webp *.tiff *.bmp *.heic # Photos
    not path *.mp3 *.wav *.flac *.aac *.ogg *.m4a *.wma *.opus *.mid *.midi # Music
    not path *.mp4 *.mkv *.avi *.mov *.wmv *.flv *.webm *.m4v *.mpg *.mpeg # Video
    not path *.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx *.txt *.rtf *.epub # Docs
    not path *.zip *.tar *.gz *.rar *.7z *.bz2 *.xz *.iso *.dmg # Archives
    # Don't scan Websocket connections specifically on my code-server hosts
    not expression {header.Upgrade}.contains('websocket') && ({host}.startsWith('{{ code_personal_host }}') || {host}.startsWith('{{ code_work_host }}'))
  }

  coraza_waf @waf_scan {

    load_owasp_crs

    directives `
      Include @coraza.conf-recommended
      # block_search_ip=0 disables ip reputation checks (slow if not tuned)
      SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=2"
      # Threshold: 5 (Strict). Defaults are usually higher.
      SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
      SecRule REQUEST_HEADERS:Content-Type "@contains multipart/form-data" \
        "id:1005,phase:1,nolog,pass,ctl:requestBodyAccess=Off"

      # --- Load Rules ---
      Include @crs-setup.conf.example
      Include @owasp_crs/*.conf

      # --- Custom Overrides ---
      # Example: Whitelist a specific scanner IP
      # SecRule REMOTE_ADDR "@ipMatch 192.168.1.50" "id:1000,phase:1,allow,nolog,ctl:ruleEngine=Off"

      # Don't scan for Unix Command execution for username fields
      SecRule REQUEST_URI ".*"\
        "id:1010,phase:1,pass,nolog,\
        ctl:ruleRemoveTargetById=932260;ARGS:u,\
        ctl:ruleRemoveTargetById=932260;ARGS:username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.u"

      # Don't scan Grafana when it uses Prometheus sfuff
      SecRule REQUEST_HEADERS:Host "@streq {{ metrics_host }}.{{ internet_host }}" \
        "id:1012,phase:1,pass,nolog,chain"
        SecRule REQUEST_URI "@contains /api/ds/query" \
          "ctl:requestBodyAccess=Off"

      # Don't scan code-server when it uses Gemini Code Asssit
      SecRule REQUEST_HEADERS:Host "@rx ^({{ code_personal_host }}|{{ code_work_host }})" \
        "id:900100,\
        phase:1,\
        pass,\
        nolog,\
        ctl:ruleRemoveTargetById=930120;ARGS:vscode-resource-base-authority"

      # Reject requests when Coraza doesn't like them
      SecRuleEngine On

      # Scan Response bodies
      SecResponseBodyAccess On

      # Only scan response bodies that are not binaries
      SecResponseBodyMimeType text/plain text/html text/xml application/json application/javascript

      # Cap the response buffer at 512KB
      SecResponseBodyLimit 524288

      # If a response body if too big, process it partially
      SecResponseBodyLimitAction ProcessPartial

      # Process request bodies in small 64KB chunks
      SecRequestBodyInMemoryLimit 65536

      # Reject uploads larger than 200MB
      SecRequestBodyLimit 209715200
      SecRequestBodyLimitAction Reject

      # Stop matching if a Regex takes too much work.
      SecPcreMatchLimit 1500
      SecPcreMatchLimitRecursion 1500

      # --- Audit Logging ---
      SecAuditLog /var/log/caddy/coraza_audit.log
      SecAuditLogFormat json
      SecAuditLogParts ABIJDEFHZ
      SecAuditEngine RelevantOnly
    `
  }
}

# Error Handling
(error_handler) {
  handle_errors {
    @blocked expression {err.status_code} == 403
    respond @blocked "Request blocked by OWASP Coraza WAF" 403
  }
}

# Services Definition
# VPN Service

{{ vpn_host }}.{{ internet_host }} {
  import logging vpn.log
  import letsencrypt_cloudflare_dns
  import proxy 10.0.254.3:8080
}


# Authentication portal

{{ auth_host }}.{{ internet_host }} {
  import logging keycloak.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ auth_host }}.{{ internet_host }}
}

{{ remote_host }}.{{ internet_host }} {
  import logging guacamole.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ remote_host }}.{{ internet_host }}
}

{{ code_personal_host }}.{{ internet_host }} {
  import logging personal_code.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ code_personal_host }}.{{ internet_host }}
}

{{ code_work_host }}.{{ internet_host }} {
  import logging work_code.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ code_work_host }}.{{ internet_host }}
}

# Music service

{{ music_host }}.{{ internet_host }} {
  import logging navidrome.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ music_host }}.{{ internet_host }}
}

# Note taking service

{{ notes_host }}.{{ internet_host }} {
  import logging notes.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ notes_host }}.{{ internet_host }}
}

{{ password_mgr_host }}.{{ internet_host }} {
  import logging vaultwarden.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ password_mgr_host }}.{{ internet_host }}
}

# RSS service

{{ rss_host }}.{{ internet_host }} {
  import logging rss.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ rss_host }}.{{ internet_host }}
}

# Photos service

{{ photos_host }}.{{ internet_host }} {
  import logging immich.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ photos_host }}.{{ internet_host }}
}

# Metrics service

{{ metrics_host }}.{{ internet_host }} {
  import logging grafana.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ metrics_host }}.{{ internet_host }}
}

# Registry service

{{ registry_host }}.{{ internet_host }} {
  import logging harbor.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ registry_host }}.{{ internet_host }}
}

# Home Assistant

{{ home_assistant_host }}.{{ internet_host }} {
  import logging home_assistant.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ home_assistant_host }}.{{ internet_host }}
}

# AWX

{{ automation_host }}.{{ internet_host }} {
  import logging awx.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ automation_host }}.{{ internet_host }}
}

# Termix

{{ remote_ssh_host }}.{{ internet_host }} {
  import logging termix.log
  import owasp_coraza
  import error_handler
  import letsencrypt_cloudflare_dns
  import proxy https://{{ lan_prefix }}.{{ remote_ssh_host}}.{{ internet_host }}
}
