(owasp_coraza) {

  @waf_scan {
    # Static file filter
    not {
      method GET
      path *.jpg *.jpeg *.png *.gif *.ico *.svg *.webp *.tiff *.bmp *.heic # Pictures
      path *.mp3 *.wav *.flac *.aac *.ogg *.m4a *.wma *.opus *.mid *.midi # Audio
      path *.mp4 *.mkv *.avi *.mov *.wmv *.flv *.webm *.m4v *.mpg *.mpeg # Video
      path *.pdf *.doc *.docx *.xls *.xlsx *.ppt *.pptx *.txt *.rtf *.epub # Documents
      path *.zip *.tar *.gz *.rar *.7z *.bz2 *.xz *.iso *.dmg # Archives
    }
    # Ultimate Websocket Filter
    not {
      method GET
      header Connection *Upgrade*
      header Upgrade websocket
      path / /api/websocket /notifications/hub /guacamole/websocket-tunnel /api/live/ws /stable-* /socket.io/* /_static/src/browser/*
    }
  }

  coraza_waf @waf_scan {

    load_owasp_crs

    directives `
      Include @coraza.conf-recommended
      # block_search_ip=0 disables ip reputation checks (slow if not tuned)
      SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level=2"
      # Threshold: 5 (Strict). Defaults are usually higher.
      SecAction "id:900110,phase:1,nolog,pass,t:none,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
      SecRule REQUEST_HEADERS:Content-Type "@contains multipart/form-data" \
        "id:1005,phase:1,nolog,pass,ctl:requestBodyAccess=Off"

      # --- Load Rules ---
      Include @crs-setup.conf.example
      Include @owasp_crs/*.conf

      # --- Custom Overrides ---
      # Example: Whitelist a specific scanner IP
      # SecRule REMOTE_ADDR "@ipMatch 192.168.1.50" "id:1000,phase:1,allow,nolog,ctl:ruleEngine=Off"

      # Don't scan for Unix Command execution for username fields
      SecRule REQUEST_URI ".*"\
        "id:1010,phase:1,pass,nolog,\
        ctl:ruleRemoveTargetById=932260;ARGS:u,\
        ctl:ruleRemoveTargetById=932260;ARGS:username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.username,\
        ctl:ruleRemoveTargetById=932260;ARGS:json.u"

      # Don't scan Grafana when it uses Prometheus sfuff
      SecRule REQUEST_HEADERS:Host "@streq {{ metrics_host }}.{{ internet_host }}" \
        "id:1012,phase:1,pass,nolog,chain"
        SecRule REQUEST_URI "@contains /api/ds/query" \
          "ctl:requestBodyAccess=Off"

      # Don't scan Grafana when saving dashboards
      SecRule REQUEST_HEADERS:Host "@streq metrics.baremetalcloud.org" \
        "id:1015,phase:1,pass,nolog,chain"
        SecRule REQUEST_URI "@beginsWith /apis/dashboard.grafana.app" \
          "ctl:ruleRemoveByTag=OWASP_CRS"

      # Don't scan code-server when it uses Gemini Code Asssit
      SecRule REQUEST_HEADERS:Host "@rx ^({{ code_personal_host }}|{{ code_work_host }})" \
        "id:900100,\
        phase:1,\
        pass,\
        nolog,\
        ctl:ruleRemoveTargetById=930120;ARGS:vscode-resource-base-authority"

      # Don't scan Trilium admin API
      SecRule REQUEST_HEADERS:Host "@streq {{ notes_host }}.{{ internet_host }}" \
        "id:1014,phase:1,pass,nolog,chain"
          SecRule REQUEST_URI "@beginsWith /api/options" \
            "ctl:responseBodyAccess=Off"

      # Reject requests when Coraza doesn't like them
      SecRuleEngine On

      # Scan Response bodies
      SecResponseBodyAccess On

      # Only scan response bodies that are not binaries
      SecResponseBodyMimeType text/plain text/html text/xml application/json application/javascript

      # Cap the response buffer at 512KB
      SecResponseBodyLimit 524288

      # If a response body if too big, process it partially
      SecResponseBodyLimitAction ProcessPartial

      # Process request bodies in small 64KB chunks
      SecRequestBodyInMemoryLimit 65536

      # Reject uploads larger than 200MB
      SecRequestBodyLimit 209715200
      SecRequestBodyLimitAction Reject

      # Stop matching if a Regex takes too much work.
      SecPcreMatchLimit 1500
      SecPcreMatchLimitRecursion 1500

      # --- Audit Logging ---
      SecAuditLog /var/log/caddy/coraza_audit.log
      SecAuditLogFormat json
      SecAuditLogParts ABCEFHIJKZ
      SecAuditEngine RelevantOnly
    `
  }
}
