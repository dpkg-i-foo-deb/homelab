server:
  http_listen_port: 9080
  grpc_listen_port: 0
positions:
  filename: /tmp/positions.yaml
clients:
  - url: http://10.0.1.12:3100/loki/api/v1/push
scrape_configs:
  # OWASP Coraza Audit Log (Security Events)
  - job_name: caddy_waf
    static_configs:
      - targets:
          - localhost
        labels:
          job: caddy_waf
          caddy_server: "{{ caddy_promtail_host_tag }}"
          __path__: /var/log/caddy/coraza_audit.log
    pipeline_stages:
      # 1. Extract the raw tags string to scan
      - json:
          expressions:
            timestamp: transaction.timestamp
            client_ip: transaction.client_ip
            host:      transaction.server_id
            uri:       transaction.request.uri
            method:    transaction.request.method
            ua:        transaction.request.headers."user-agent"[0]
            blocked:   transaction.is_interrupted

            rule_id:     messages[0].data.id
            severity:    messages[0].data.severity
            attack_msg:  messages[0].message
            attack_data: messages[0].data.data

            # We get the tags as a raw string to check them easily
            _tags: messages[0].data.tags

      # 2. Set Default to "Uncategorized"
      - template:
          source: attack_cat
          template: 'Uncategorized'

      # 3. LOGIC START: Check for Platform/Language (Low Priority)
      # "Does the tag list contain 'platform-' or 'language-'?"
      - match:
          selector: '{job="caddy_waf"} |= "platform-" |= "language-"'
          stages:
            - regex:
                source: _tags
                expression: '.*(?P<attack_cat>(platform|language)-[a-zA-Z0-9]+).*'

      # 4. Check for Policy (Medium Priority)
      # "Does the tag list contain 'policy-'?"
      # If yes, this overwrites the previous one.
      - match:
          selector: '{job="caddy_waf"} |= "policy-"'
          stages:
            - regex:
                source: _tags
                expression: '.*(?P<attack_cat>policy-[a-zA-Z0-9]+).*'

      # 5. Check for Attack (High Priority - The Boss)
      # "Does the tag list contain 'attack-'?"
      # If yes, this overwrites everything else.
      - match:
          selector: '{job="caddy_waf"} |= "attack-"'
          stages:
            - regex:
                source: _tags
                expression: '.*(?P<attack_cat>attack-[a-zA-Z0-9]+).*'

      # 6. Apply the Final Labels
      - labels:
          host:
          method:
          rule_id:
          attack_cat:
          severity:
          blocked:
  # Service Logs
  - job_name: caddy
    static_configs:
      - targets:
          - localhost
        labels:
          job: caddy
          agent: caddy-promtail
          host: "{{ caddy_promtail_host_tag }}"
          __path__: /var/log/caddy/*.log
    pipeline_stages:
      # Exclude WAF log
      - match:
          selector: '{__path__=~".*coraza_audit.log"}'
          action: drop
      #  Extract Service Name from Filename
      # If file is "/var/log/caddy/navidrome.log", label becomes service="navidrome"
      - regex:
          source: __path__
          expression: '/var/log/caddy/(?P<service_name>.*)\.log'
      - labels:
          service_name:
      # Parse the Caddy JSON
      - json:
          expressions:
            status: status
            duration: duration
            method: request.method
            uri: request.uri
      - labels:
          status:
# Fix Time
      - timestamp:
          source: ts
          format: Unix
