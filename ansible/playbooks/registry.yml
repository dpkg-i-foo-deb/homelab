- name: Configure private registry
  hosts: registry_servers
  vars:
    registry_user: 'registry'
    registry_network: 'registry'
    registry_pg_user: 'registry'
    registry_pg_pass: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65666664633833663532376439393630396338363131333966666338306364363936656165376235
      3266646338636135666231306432343463663633646231340a613164396631376630633636343830
      34653661393037666364636465303136346434623739373435323464313930663362666435313866
      3131366636643132650a373565626334316161336664646232306161323034326334306430343561
      65306233393233653636323634623039666537303534373963313463636562326234383862633461
      3535663438396237313830666431613236376462373230376563
    registry_redis_pass: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      32646439343566356536373464646236623132663038386436306433653465643930643939303238
      3264323830313163333032386332306636633365373862630a616530353839623961643035386331
      35613633316334636463653865656135363266613162373035373435336265383535343165626232
      3366623561356338320a613935386439636163626362356666643334613436313761666238353836
      36663230626438396339636237323931393661303564303135623437333431393737633562313763
      3766663830353632623130373435363162636230306237336133

  tasks:

    - name: Ensure there's a virtual network for Quay
      ansible.builtin.import_role:
        name: podman
        tasks_from: network
      vars:
        podman_network: '{{ registry_network }}'
        podman_user: '{{ registry_network }}'

    - name: Deploy Postgres for private registry
      ansible.builtin.import_role:
        name: postgres
      vars:
        postgres_podman_user: '{{ registry_user }}'
        postgres_container: 'quay-postgres'
        postgres_data_vol: 'quay-postgres'
        postgres_db: 'quay'
        postgres_user: '{{ registry_pg_user }}'
        postgres_pass: '{{ registry_pg_pass }}'
        postgres_network: '{{ registry_network }}'

    - name: Deploy Redis for private registry
      ansible.builtin.import_role:
        name: redis
      vars:
        redis_user: '{{ registry_user }}'
        redis_container: 'quay-redis'
        redis_password: '{{ registry_redis_pass }}'
        redis_network: '{{ registry_network }}'

    - name: Deploy Quay Registry
      ansible.builtin.import_role:
        name: quay
      vars:
        quay_user: '{{ registry_user }}'
        quay_container: 'quay'
        quay_network: '{{ registry_network }}'
        quay_config_dir: '/var/quay'
        quay_blobs_dir: '/blobs'
        quay_redis_host: 'quay-redis'
        quay_redis_pass: '{{ registry_redis_pass }}'
        quay_db_user: '{{ registry_pg_user }}'
        quay_db_pass: '{{ registry_pg_pass }}'
        quay_db_host: 'quay-postgres'
        quay_db_name: 'quay'
        quay_external_tls_termination: 'true'
        quay_registry_title: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63616164626663303161626361366136383130636433653961363939633036623536333239616532
          6135643134373132653934666437643439613765386162630a346336343963343134353866316638
          61633539383237653861323766316263623361316637393136623363663166616463343633616236
          3330633066333861650a346565386431653165326363623532383635386437323465666664336162
          63646663336662396361343965396534396262333361623737373036613562626336
        quay_short_registry_title: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33376562653963353036306530363733623165363266323237333731646436336636666537376130
          6163366264623938326530373136646338303764303766610a613336323132303566643438616533
          34333338666139643261336133633831386134396664303936633063636637396332366164626439
          6434303235653038300a396436613639653539643461303466333931353333633065343835303062
          32653834656134373462343263393666333131366336653035393335333632386333
        quay_registry_hostname: '{{ registry_host }}.{{ internet_host }}'
