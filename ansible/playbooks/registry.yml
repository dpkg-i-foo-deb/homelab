- name: Configure private registry
  hosts: registry_servers
  vars:
    registry_user: 'registry'
    registry_network: 'registry'
    registry_pg_user: 'registry'
    registry_pg_pass: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65666664633833663532376439393630396338363131333966666338306364363936656165376235
      3266646338636135666231306432343463663633646231340a613164396631376630633636343830
      34653661393037666364636465303136346434623739373435323464313930663362666435313866
      3131366636643132650a373565626334316161336664646232306161323034326334306430343561
      65306233393233653636323634623039666537303534373963313463636562326234383862633461
      3535663438396237313830666431613236376462373230376563

  tasks:

    - name: Ensure there's a virtual network for Quay
      ansible.builtin.import_role:
        name: podman
        tasks_from: network
      vars:
        podman_network: '{{ registry_network }}'
        podman_user: '{{ registry_network }}'

    - name: Deploy Postgres for private registry
      ansible.builtin.import_role:
        name: postgres
      vars:
        postgres_podman_user: '{{ registry_user }}'
        postgres_container: 'quay-postgres'
        postgres_data_vol: 'quay-postgres'
        postgres_db: 'quay'
        postgres_user: '{{ registry_pg_user }}'
        postgres_pass: '{{ registry_pg_pass }}'
        postgres_network: '{{ registry_network }}'